<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê¸€ ìˆ˜ì • - ë„ë˜ìš¸ë² ì´ìŠ¤</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Malgun Gothic', sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 40px;
        }

        .header {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }

        .header h1 {
            font-size: 24px;
            color: #333;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #333;
            font-size: 15px;
        }

        .form-group select,
        .form-group input[type="text"],
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 15px;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .form-group select:focus,
        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #1976d2;
        }

        .form-group textarea {
            min-height: 300px;
            resize: vertical;
        }

        /* íŒŒì¼ ì—…ë¡œë“œ ì˜ì—­ */
        .upload-section {
            margin-bottom: 25px;
        }

        .upload-area {
            border: 2px dashed #d0d0d0;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            background: #fafafa;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-area:hover,
        .upload-area.drag-over {
            border-color: #1976d2;
            background: #f0f7ff;
        }

        .upload-area-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .upload-icon {
            font-size: 48px;
        }

        .upload-text {
            font-size: 16px;
            color: #666;
            margin-bottom: 5px;
        }

        .upload-hint {
            font-size: 13px;
            color: #999;
        }

        .upload-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            justify-content: center;
        }

        .upload-btn {
            padding: 10px 20px;
            background: #1976d2;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .upload-btn:hover {
            background: #1565c0;
        }

        .upload-btn.secondary {
            background: #4caf50;
        }

        .upload-btn.secondary:hover {
            background: #45a049;
        }

        /* ì—…ë¡œë“œëœ íŒŒì¼ ëª©ë¡ */
        .uploaded-files {
            margin-top: 20px;
        }

        .file-list-title {
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
        }

        .file-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 8px;
            transition: all 0.2s;
        }

        .file-item:hover {
            background: #e9ecef;
        }

        .file-preview {
            width: 50px;
            height: 50px;
            border-radius: 6px;
            object-fit: cover;
            background: #ddd;
            flex-shrink: 0;
        }

        .file-icon {
            width: 50px;
            height: 50px;
            border-radius: 6px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            flex-shrink: 0;
        }

        .file-info {
            flex: 1;
            min-width: 0;
        }

        .file-name {
            font-size: 14px;
            font-weight: 600;
            color: #333;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .file-size {
            font-size: 12px;
            color: #666;
            margin-top: 2px;
        }

        .file-remove {
            padding: 6px 12px;
            background: #f44336;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .file-remove:hover {
            background: #d32f2f;
        }

        .file-count {
            font-size: 13px;
            color: #666;
            margin-top: 10px;
        }

        .file-count.warning {
            color: #ff9800;
            font-weight: 600;
        }

        .captcha-box {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
        }

        .captcha-question {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            text-align: center;
        }

        .captcha-input {
            width: 100%;
            max-width: 200px;
            margin: 0 auto;
            display: block;
            text-align: center;
            font-size: 16px;
            font-weight: 600;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 30px;
        }

        .submit-btn,
        .cancel-btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .submit-btn {
            background: linear-gradient(135deg, #42a5f5, #1976d2);
            color: white;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(25, 118, 210, 0.3);
        }

        .submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .cancel-btn {
            background: white;
            color: #666;
            border: 2px solid #e0e0e0;
        }

        .cancel-btn:hover {
            background: #f5f5f5;
        }

        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .notice-warning {
            background: #fff3e0;
            color: #e65100;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        input[type="file"] {
            display: none;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }

            .button-group {
                flex-direction: column;
            }

            .upload-buttons {
                flex-direction: column;
            }

            .upload-btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>âœï¸ ê¸€ ìˆ˜ì •</h1>
            <p>ê²Œì‹œê¸€ ë‚´ìš©ì„ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
        </div>

        <div class="error-message" id="errorMessage"></div>
        <div class="notice-warning" id="noticeWarning">
            âš ï¸ ê³µì§€ì‚¬í•­ì€ ê´€ë¦¬ìë§Œ ì‘ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        </div>

        <form id="writeForm">
            <div class="form-group">
                <label for="category">ì¹´í…Œê³ ë¦¬ *</label>
                <select id="category" name="category" required>
                    <option value="">ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                    <option value="notice">ê³µì§€ì‚¬í•­ (ê´€ë¦¬ì ì „ìš©)</option>
                    <option value="info">ìë£ŒÂ·ì •ë³´ ê³µìœ </option>
                    <option value="question">ì§ˆë¬¸ê²Œì‹œíŒ</option>
                    <option value="free">ììœ ê²Œì‹œíŒ</option>
                </select>
            </div>

            <div class="form-group">
                <label for="title">ì œëª© *</label>
                <input type="text" id="title" name="title" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" required maxlength="100">
            </div>

            <div class="form-group">
                <label for="content">ë‚´ìš© *</label>
                <textarea id="content" name="content" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš” (Ctrl+Vë¡œ ì´ë¯¸ì§€ ë¶™ì—¬ë„£ê¸° ê°€ëŠ¥)" required></textarea>
            </div>

            <!-- íŒŒì¼ ì—…ë¡œë“œ ì˜ì—­ -->
            <div class="upload-section">
                <label>ì´ë¯¸ì§€ & íŒŒì¼ ì²¨ë¶€ (ìµœëŒ€ 30ê°œ, ê° 10MB)</label>
                <div class="upload-area" id="uploadArea">
                    <div class="upload-area-content">
                        <div class="upload-icon">ğŸ“</div>
                        <div class="upload-text">íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì—…ë¡œë“œ</div>
                        <div class="upload-hint">ì´ë¯¸ì§€: JPG, PNG, GIF, WebP | íŒŒì¼: PDF, DOC, XLS, PPT, HWP, ZIP ë“±</div>
                        <div class="upload-buttons">
                            <button type="button" class="upload-btn" onclick="selectFiles()">
                                ğŸ–¼ï¸ ì´ë¯¸ì§€ ì„ íƒ
                            </button>
                            <button type="button" class="upload-btn secondary" onclick="selectFiles()">
                                ğŸ“„ íŒŒì¼ ì„ íƒ
                            </button>
                        </div>
                    </div>
                </div>
                <input type="file" id="fileInput" multiple accept="image/*,.pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt,.hwp,.zip,.rar,.7z">

                <div class="uploaded-files" id="uploadedFiles" style="display: none;">
                    <div class="file-list-title">ì²¨ë¶€ëœ íŒŒì¼</div>
                    <div id="fileList"></div>
                    <div class="file-count" id="fileCount">0 / 30ê°œ</div>
                </div>
            </div>

            <div class="button-group">
                <button type="button" class="cancel-btn" onclick="goBack()">ì·¨ì†Œ</button>
                <button type="submit" class="submit-btn" id="submitBtn">ìˆ˜ì • ì™„ë£Œ</button>
            </div>
        </form>
    </div>

    <script>
        let currentUser = null;
        let uploadedFiles = []; // ì—…ë¡œë“œëœ íŒŒì¼ ì •ë³´ ì €ì¥
        let postId = null;
        let originalPost = null;

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
        window.addEventListener('load', async () => {
            // URLì—ì„œ ê²Œì‹œê¸€ ID ê°€ì ¸ì˜¤ê¸°
            const urlParams = new URLSearchParams(window.location.search);
            postId = urlParams.get('id');

            if (!postId) {
                alert('ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤.');
                window.location.href = '/';
                return;
            }

            await checkLogin();
            await loadPost();
            setupCategoryCheck();
            setupFileUpload();
            setupPasteImage();
        });

        // ë¡œê·¸ì¸ í™•ì¸
        async function checkLogin() {
            try {
                const response = await fetch('/api/user');
                const data = await response.json();

                if (!data.success || !data.user) {
                    alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                    window.location.href = '/auth/kakao';
                    return;
                }

                currentUser = data.user;
            } catch (error) {
                console.error('ë¡œê·¸ì¸ í™•ì¸ ì‹¤íŒ¨:', error);
                alert('ë¡œê·¸ì¸ ìƒíƒœë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                window.location.href = '/';
            }
        }

        // ê¸°ì¡´ ê²Œì‹œê¸€ ë°ì´í„° ë¡œë“œ
        async function loadPost() {
            try {
                const response = await fetch(`/api/posts/${postId}`);
                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.message);
                }

                originalPost = data.post;

                // ê¶Œí•œ í™•ì¸ (ì‘ì„±ì ë³¸ì¸ ë˜ëŠ” ê´€ë¦¬ìë§Œ ìˆ˜ì • ê°€ëŠ¥)
                if (currentUser.id !== originalPost.authorId && currentUser.role !== 'admin') {
                    alert('ìˆ˜ì • ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
                    window.location.href = `/post-detail?id=${postId}`;
                    return;
                }

                // í¼ì— ë°ì´í„° ì±„ìš°ê¸°
                document.getElementById('category').value = originalPost.category;
                document.getElementById('title').value = originalPost.title;
                document.getElementById('content').value = originalPost.content;

                // ê¸°ì¡´ ì²¨ë¶€íŒŒì¼ ë¡œë“œ
                if (originalPost.images && originalPost.images.length > 0) {
                    uploadedFiles = uploadedFiles.concat(originalPost.images);
                }
                if (originalPost.files && originalPost.files.length > 0) {
                    uploadedFiles = uploadedFiles.concat(originalPost.files);
                }

                if (uploadedFiles.length > 0) {
                    renderFileList();
                }

            } catch (error) {
                console.error('ê²Œì‹œê¸€ ë¡œë“œ ì‹¤íŒ¨:', error);
                alert('ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                window.location.href = '/';
            }
        }

        // ì¹´í…Œê³ ë¦¬ ì„ íƒ ì‹œ ê³µì§€ì‚¬í•­ ê²½ê³ 
        function setupCategoryCheck() {
            const categorySelect = document.getElementById('category');
            const noticeWarning = document.getElementById('noticeWarning');

            categorySelect.addEventListener('change', () => {
                if (categorySelect.value === 'notice') {
                    if (currentUser && currentUser.role === 'admin') {
                        noticeWarning.style.display = 'none';
                    } else {
                        noticeWarning.style.display = 'block';
                        noticeWarning.textContent = 'âš ï¸ ê³µì§€ì‚¬í•­ì€ ê´€ë¦¬ìë§Œ ì‘ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.';
                    }
                } else {
                    noticeWarning.style.display = 'none';
                }
            });
        }

        // íŒŒì¼ ì—…ë¡œë“œ ì„¤ì •
        function setupFileUpload() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');

            // ë“œë˜ê·¸ì•¤ë“œë¡­
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('drag-over');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('drag-over');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('drag-over');

                const files = Array.from(e.dataTransfer.files);
                handleFiles(files);
            });

            // í´ë¦­í•˜ì—¬ ì—…ë¡œë“œ
            uploadArea.addEventListener('click', (e) => {
                if (e.target.tagName !== 'BUTTON') {
                    fileInput.click();
                }
            });

            fileInput.addEventListener('change', (e) => {
                const files = Array.from(e.target.files);
                handleFiles(files);
                fileInput.value = ''; // ê°™ì€ íŒŒì¼ ì¬ì„ íƒ ê°€ëŠ¥í•˜ë„ë¡
            });
        }

        // íŒŒì¼ ì„ íƒ ë²„íŠ¼
        function selectFiles() {
            document.getElementById('fileInput').click();
        }

        // í´ë¦½ë³´ë“œ ì´ë¯¸ì§€ ë¶™ì—¬ë„£ê¸°
        function setupPasteImage() {
            const contentArea = document.getElementById('content');

            contentArea.addEventListener('paste', async (e) => {
                const items = e.clipboardData.items;
                const imageFiles = [];

                for (let item of items) {
                    if (item.type.indexOf('image') !== -1) {
                        e.preventDefault();
                        const file = item.getAsFile();
                        imageFiles.push(file);
                    }
                }

                if (imageFiles.length > 0) {
                    await handleFiles(imageFiles);
                    showSuccess(`${imageFiles.length}ê°œì˜ ì´ë¯¸ì§€ê°€ ë¶™ì—¬ë„£ê¸°ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                }
            });
        }

        // íŒŒì¼ ì²˜ë¦¬
        async function handleFiles(files) {
            if (uploadedFiles.length + files.length > 30) {
                showError(`ìµœëŒ€ 30ê°œê¹Œì§€ë§Œ ì²¨ë¶€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. (í˜„ì¬ ${uploadedFiles.length}ê°œ)`);
                return;
            }

            const formData = new FormData();
            files.forEach(file => {
                // íŒŒì¼ í¬ê¸° ì²´í¬ (10MB)
                if (file.size > 10 * 1024 * 1024) {
                    showError(`${file.name}ì€(ëŠ”) 10MBë¥¼ ì´ˆê³¼í•©ë‹ˆë‹¤.`);
                    return;
                }
                formData.append('files', file);
            });

            try {
                const submitBtn = document.getElementById('submitBtn');
                submitBtn.disabled = true;
                submitBtn.textContent = 'ì—…ë¡œë“œ ì¤‘...';

                const response = await fetch('/api/upload-attachments', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    uploadedFiles = uploadedFiles.concat(data.files);
                    renderFileList();
                    showSuccess(`${data.files.length}ê°œì˜ íŒŒì¼ì´ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.`);
                } else {
                    throw new Error(data.message);
                }
            } catch (error) {
                console.error('íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨:', error);
                showError('íŒŒì¼ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
            } finally {
                const submitBtn = document.getElementById('submitBtn');
                submitBtn.disabled = false;
                submitBtn.textContent = 'ì‘ì„± ì™„ë£Œ';
            }
        }

        // íŒŒì¼ ëª©ë¡ ë Œë”ë§
        function renderFileList() {
            const fileList = document.getElementById('fileList');
            const uploadedFilesSection = document.getElementById('uploadedFiles');
            const fileCount = document.getElementById('fileCount');

            if (uploadedFiles.length === 0) {
                uploadedFilesSection.style.display = 'none';
                return;
            }

            uploadedFilesSection.style.display = 'block';
            fileCount.textContent = `${uploadedFiles.length} / 30ê°œ`;

            if (uploadedFiles.length >= 25) {
                fileCount.classList.add('warning');
            } else {
                fileCount.classList.remove('warning');
            }

            fileList.innerHTML = uploadedFiles.map((file, index) => {
                const isImage = file.type.startsWith('image/');
                const sizeInKB = (file.size / 1024).toFixed(1);
                const sizeText = sizeInKB > 1024 ? `${(sizeInKB / 1024).toFixed(1)} MB` : `${sizeInKB} KB`;

                return `
                    <div class="file-item">
                        ${isImage ?
                            `<img src="${file.url}" class="file-preview" alt="ë¯¸ë¦¬ë³´ê¸°">` :
                            `<div class="file-icon">ğŸ“„</div>`
                        }
                        <div class="file-info">
                            <div class="file-name">${file.originalName}</div>
                            <div class="file-size">${sizeText}</div>
                        </div>
                        <button type="button" class="file-remove" onclick="removeFile(${index})">ì‚­ì œ</button>
                    </div>
                `;
            }).join('');
        }

        // íŒŒì¼ ì‚­ì œ
        function removeFile(index) {
            uploadedFiles.splice(index, 1);
            renderFileList();
        }

        // í¼ ì œì¶œ
        document.getElementById('writeForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const category = document.getElementById('category').value;
            const title = document.getElementById('title').value.trim();
            const content = document.getElementById('content').value.trim();

            // ìœ íš¨ì„± ê²€ì‚¬
            if (!category || !title || !content) {
                showError('ëª¨ë“  í•„ìˆ˜ í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            // ê³µì§€ì‚¬í•­ ê¶Œí•œ í™•ì¸
            if (category === 'notice' && currentUser.role !== 'admin') {
                showError('ê³µì§€ì‚¬í•­ì€ ê´€ë¦¬ìë§Œ ì‘ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                return;
            }

            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'ìˆ˜ì • ì¤‘...';

            try {
                // ì´ë¯¸ì§€ì™€ íŒŒì¼ ë¶„ë¦¬
                const images = uploadedFiles.filter(f => f.type.startsWith('image/'));
                const files = uploadedFiles.filter(f => !f.type.startsWith('image/'));

                // ê²Œì‹œê¸€ ìˆ˜ì • (PUT ìš”ì²­)
                const response = await fetch(`/api/posts/${postId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        category,
                        title,
                        content,
                        images,
                        files
                    })
                });

                const data = await response.json();

                if (data.success) {
                    alert('ê²Œì‹œê¸€ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!');
                    window.location.href = `/post-detail?id=${postId}`;
                } else {
                    throw new Error(data.message);
                }

            } catch (error) {
                console.error('ê²Œì‹œê¸€ ìˆ˜ì • ì‹¤íŒ¨:', error);
                showError(error.message || 'ê²Œì‹œê¸€ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                submitBtn.disabled = false;
                submitBtn.textContent = 'ìˆ˜ì • ì™„ë£Œ';
            }
        });

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function showSuccess(message) {
            // ê°„ë‹¨í•œ ì„±ê³µ ë©”ì‹œì§€ (ì˜µì…˜)
            console.log('âœ…', message);
        }

        function goBack() {
            if (confirm('ìˆ˜ì • ì¤‘ì¸ ë‚´ìš©ì´ ì‚¬ë¼ì§‘ë‹ˆë‹¤. ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                window.location.href = `/post-detail?id=${postId}`;
            }
        }
    </script>
</body>
</html>
